name: Release Workflow
on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: read

jobs:
  might_release:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Get Go version from toolchain
        id: go-version
        run: |
          TOOLCHAIN_VERSION=$(grep -E '^toolchain go[0-9]+\.[0-9]+(\.[0-9]+)?$' go.mod | cut -d ' ' -f 2 | sed 's/^go//')
          if [ -n "$TOOLCHAIN_VERSION" ]; then
            echo "Found toolchain version: $TOOLCHAIN_VERSION"
            echo "version=$TOOLCHAIN_VERSION" >> $GITHUB_OUTPUT
          else
            GO_VERSION=$(grep -E '^go [0-9]+\.[0-9]+(\.[0-9]+)?$' go.mod | cut -d ' ' -f 2)
            echo "Found go directive version: $GO_VERSION"
            echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          cache: true

      - name: Prepare Release Variables
        id: vars
        run: |
          repo_name=${GITHUB_REPOSITORY##*/}
          echo "Repository name: $repo_name"
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # Tag push
            tag_name=${GITHUB_REF#refs/tags/}
            is_release_type_latest=false
            echo "Building release for tag: $tag_name"
          elif [[ $GITHUB_REF == refs/heads/master ]]; then
            # Master branch push
            tag_name=latest
            is_release_type_latest=true
            echo "Building latest release"
          else
            # Other pushes - use branch name or commit SHA
            tag_name="test-${GITHUB_REF_NAME:-${GITHUB_SHA:0:7}}"
            is_release_type_latest=false
            echo "Building test release: $tag_name"
          fi
          
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "is_release_type_latest=$is_release_type_latest" >> $GITHUB_OUTPUT
          echo "tarball_prefix=${repo_name}_${tag_name}" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "Output variables:"
          echo "- tag_name: $tag_name"
          echo "- is_release_type_latest: $is_release_type_latest"
          echo "- tarball_prefix: ${repo_name}_${tag_name}"

      - name: Issue Release Assets
        uses: ignite/cli/actions/cli@main
        with:
          args: chain build --release --release.prefix ${{ steps.vars.outputs.tarball_prefix }} -y -t linux:amd64 #-t darwin:amd64 -t darwin:arm64 -y
        env:
          DO_NOT_TRACK: 1
          GOFLAGS: "-buildvcs=false"

      - name: Delete the "latest" Release
        if: steps.vars.outputs.is_release_type_latest == 'true'
        uses: dev-drprasad/delete-tag-and-release@v1.0.1
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish the Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: release/*
          prerelease: ${{ github.ref != 'refs/heads/master' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
