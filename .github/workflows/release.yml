name: Release Workflow
on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  might_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Get Go version from toolchain
        id: go-version
        run: |
          TOOLCHAIN_VERSION=$(grep -E '^toolchain go[0-9]+\.[0-9]+(\.[0-9]+)?$' go.mod | cut -d ' ' -f 2 | sed 's/^go//')
          if [ -n "$TOOLCHAIN_VERSION" ]; then
            echo "version=$TOOLCHAIN_VERSION" >> $GITHUB_OUTPUT
          else
            GO_VERSION=$(grep -E '^go [0-9]+\.[0-9]+(\.[0-9]+)?$' go.mod | cut -d ' ' -f 2)
            echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          cache: true

      - name: Prepare Release Variables
        id: vars
        run: |
          repo_name=${GITHUB_REPOSITORY##*/}
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # Tag push
            tag_name=${GITHUB_REF#refs/tags/}
            is_release_type_latest=false
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            # Main branch push
            tag_name=latest
            is_release_type_latest=true
          else
            # Other pushes
            echo "Not a release trigger"
            exit 0
          fi
          
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "is_release_type_latest=$is_release_type_latest" >> $GITHUB_OUTPUT
          echo "tarball_prefix=${repo_name}_${tag_name}" >> $GITHUB_OUTPUT

      - name: Issue Release Assets
        uses: ignite/cli/actions/cli@main
        with:
          args: chain build --release --release.prefix ${{ steps.vars.outputs.tarball_prefix }} -t linux:amd64 -t darwin:amd64 -t darwin:arm64 -y
        env:
          DO_NOT_TRACK: 1
          GOFLAGS: "-buildvcs=false"

      - name: Delete the "latest" Release
        if: steps.vars.outputs.is_release_type_latest == 'true'
        uses: dev-drprasad/delete-tag-and-release@v1.0.1
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish the Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: release/*
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
