syntax = "proto3";
package lumera.audit.v1;

option go_package = "x/audit/v1/types";

import "amino/amino.proto";
import "gogoproto/gogo.proto";
import "google/api/annotations.proto";
import "cosmos_proto/cosmos.proto";
import "cosmos/base/query/v1beta1/pagination.proto";

import "lumera/audit/v1/params.proto";
import "lumera/audit/v1/audit.proto";
import "lumera/audit/v1/evidence.proto";
import "lumera/audit/v1/epoch.proto";

// Query defines the gRPC querier service.
service Query {
  // Parameters queries the parameters of the module.
  rpc Params(QueryParamsRequest) returns (QueryParamsResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/params";
  }

  // EvidenceById queries a single evidence record by id.
  rpc EvidenceById(QueryEvidenceByIdRequest) returns (QueryEvidenceByIdResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/evidence/{evidence_id}";
  }

  // EvidenceBySubject queries evidence records by subject address.
  rpc EvidenceBySubject(QueryEvidenceBySubjectRequest) returns (QueryEvidenceBySubjectResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/evidence/by_subject/{subject_address}";
  }

  // EvidenceByAction queries evidence records by action id.
  rpc EvidenceByAction(QueryEvidenceByActionRequest) returns (QueryEvidenceByActionResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/evidence/by_action/{action_id}";
  }

  // CurrentEpoch returns the current derived epoch boundaries at the current chain height.
  rpc CurrentEpoch(QueryCurrentEpochRequest) returns (QueryCurrentEpochResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/current_epoch";
  }

  // EpochAnchor returns the persisted epoch anchor for the given epoch_id.
  rpc EpochAnchor(QueryEpochAnchorRequest) returns (QueryEpochAnchorResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/epoch_anchor/{epoch_id}";
  }

  // CurrentEpochAnchor returns the persisted epoch anchor for the current epoch.
  rpc CurrentEpochAnchor(QueryCurrentEpochAnchorRequest) returns (QueryCurrentEpochAnchorResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/current_epoch_anchor";
  }

  // AssignedTargets returns the prober -> targets assignment for a given supernode_account.
  // If filter_by_epoch_id is false, it returns the assignments for the current epoch.
  rpc AssignedTargets(QueryAssignedTargetsRequest) returns (QueryAssignedTargetsResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/assigned_targets/{supernode_account}";
  }

  rpc AuditReport(QueryAuditReportRequest) returns (QueryAuditReportResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/audit_report/{epoch_id}/{supernode_account}";
  }

  rpc AuditReportsByReporter(QueryAuditReportsByReporterRequest) returns (QueryAuditReportsByReporterResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/audit_reports_by_reporter/{supernode_account}";
  }

  // SupernodeReports returns all reports that include observations about the given supernode_account.
  rpc SupernodeReports(QuerySupernodeReportsRequest) returns (QuerySupernodeReportsResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/supernode_reports/{supernode_account}";
  }

  // SelfReports returns self-reports submitted by the given supernode_account across epochs.
  rpc SelfReports(QuerySelfReportsRequest) returns (QuerySelfReportsResponse) {
    option (google.api.http).get = "/LumeraProtocol/lumera/audit/v1/self_reports/{supernode_account}";
  }
}

message QueryParamsRequest {}

message QueryParamsResponse {
  Params params = 1 [(gogoproto.nullable) = false, (amino.dont_omitempty) = true];
}

message QueryEvidenceByIdRequest {
  uint64 evidence_id = 1;
}

message QueryEvidenceByIdResponse {
  Evidence evidence = 1 [(gogoproto.nullable) = false, (amino.dont_omitempty) = true];
}

message QueryEvidenceBySubjectRequest {
  string subject_address = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  cosmos.base.query.v1beta1.PageRequest pagination = 2;
}

message QueryEvidenceBySubjectResponse {
  repeated Evidence evidence = 1 [(gogoproto.nullable) = false];
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

message QueryEvidenceByActionRequest {
  string action_id = 1;
  cosmos.base.query.v1beta1.PageRequest pagination = 2;
}

message QueryEvidenceByActionResponse {
  repeated Evidence evidence = 1 [(gogoproto.nullable) = false];
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

message QueryCurrentEpochRequest {}

message QueryCurrentEpochResponse {
  uint64 epoch_id           = 1;
  int64  epoch_start_height = 2;
  int64  epoch_end_height   = 3;
}

message QueryEpochAnchorRequest {
  uint64 epoch_id = 1;
}

message QueryEpochAnchorResponse {
  EpochAnchor anchor = 1 [(gogoproto.nullable) = false];
}

message QueryCurrentEpochAnchorRequest {}

message QueryCurrentEpochAnchorResponse {
  EpochAnchor anchor = 1 [(gogoproto.nullable) = false];
}

message QueryAssignedTargetsRequest {
  string supernode_account = 1 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
  uint64 epoch_id = 2;
  bool filter_by_epoch_id = 3;
}

message QueryAssignedTargetsResponse {
  uint64 epoch_id = 1;
  int64 epoch_start_height = 2;
  repeated uint32 required_open_ports = 3;
  repeated string target_supernode_accounts = 4 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
}

message QueryAuditReportRequest {
  uint64 epoch_id = 1;
  string supernode_account = 2 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
}

message QueryAuditReportResponse {
  AuditReport report = 1 [(gogoproto.nullable) = false];
}

message QueryAuditReportsByReporterRequest {
  string supernode_account = 1 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
  uint64 epoch_id = 2;
  cosmos.base.query.v1beta1.PageRequest pagination = 3;
  bool filter_by_epoch_id = 4;
}

message QueryAuditReportsByReporterResponse {
  repeated AuditReport reports = 1 [(gogoproto.nullable) = false];
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

message QuerySupernodeReportsRequest {
  string supernode_account = 1 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
  uint64 epoch_id = 2;
  cosmos.base.query.v1beta1.PageRequest pagination = 3;
  bool filter_by_epoch_id = 4;
}

message SupernodeReport {
  string reporter_supernode_account = 1 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
  uint64 epoch_id = 2;
  int64 report_height = 3;
  repeated PortState port_states = 4;
}

message QuerySupernodeReportsResponse {
  repeated SupernodeReport reports = 1 [(gogoproto.nullable) = false];
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}

message QuerySelfReportsRequest {
  string supernode_account = 1 [(cosmos_proto.scalar) = "cosmos.AccAddressString"];
  uint64 epoch_id = 2;
  cosmos.base.query.v1beta1.PageRequest pagination = 3;
  bool filter_by_epoch_id = 4;
}

message SelfReport {
  uint64 epoch_id = 1;
  int64 report_height = 2;
  AuditSelfReport self_report = 3 [(gogoproto.nullable) = false];
}

message QuerySelfReportsResponse {
  repeated SelfReport reports = 1 [(gogoproto.nullable) = false];
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}
